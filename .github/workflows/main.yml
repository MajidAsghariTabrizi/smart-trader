name: SmartTrader CI/CD

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # ------------------------------
    # Checkout repository
    # ------------------------------
    - name: Checkout repository
      uses: actions/checkout@v3

    # ------------------------------
    # Deploy using your EXACT secrets
    # ------------------------------
    - name: Deploy to SmartTrader Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22

        script: |
          echo "üöÄ Starting SmartTrader Deployment..."

          cd /root/smart-trader

          if [ ! -f deploy.sh ]; then
            echo "‚ùå ERROR: deploy.sh not found!"
            exit 1
          fi

          chmod +x deploy.sh

          echo "‚û° Running deploy script..."
          ./deploy.sh

          echo "‚û° Checking API health..."
          curl -s http://127.0.0.1:8000/api/health || true

          echo "‚úÖ Deployment finished successfully."

    - name: Deployment Completed
      run: echo "üéâ SmartTrader CI/CD pipeline completed successfully!"
