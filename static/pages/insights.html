<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <title>Command Center ‚Äì SmartTrader</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body class="st-body">
    <script src="/static/js/nav.js"></script>
    <div class="st-page">
        <!-- Command Center Header -->
        <header class="st-glass-card" style="margin: 1rem 0 2rem;">
            <div class="command-header">
            <div>
                    <h1 class="command-title" style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                        üß† Command Center
                        <span class="st-status-dot st-status-dot-active"></span>
                </h1>
                    <p class="command-subtitle">Real-time Bot Brain Visualization & Decision Intelligence</p>
            </div>
            <div style="text-align: right;">
                <div id="liveStatus" style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                    <span class="st-status-dot st-status-dot-active"></span>
                    <span>Bot Active</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Grid: Mobile-First Layout -->
        <div class="command-main-layout">
            <!-- Left Column: Main Visualizations -->
            <div>
                <!-- Top Row: Whale Sentiment & Market Regime -->
                <div class="command-grid-2" style="margin-bottom: 1.5rem;">
                    <!-- Whale Sentiment -->
                    <div class="st-glass-card">
                        <h2 class="st-card-header" style="margin: 0 0 1rem; font-size: 1.25rem; font-weight: 600;">Whale Sentiment & Flow</h2>
                        <div id="whaleBiasGauge" class="chart-container-small"></div>
                        <div id="whaleFlowChart" class="chart-container-small" style="margin-top: 1rem;"></div>
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Whale Activity Level</div>
                            <div id="whaleActivityHeat" class="whale-activity-heat"></div>
                        </div>
                        <div id="supplyDemandIndicator" style="margin-top: 1rem; text-align: center;"></div>
                        </div>

                    <!-- Market Regime Dashboard -->
                    <div class="st-glass-card">
                        <h2 class="st-card-header" style="margin: 0 0 1rem; font-size: 1.25rem; font-weight: 600;">Market Regime</h2>
                        <div id="regimeDashboard" style="text-align: center; padding: 1rem 0;">
                            <div id="regimeBadge" class="regime-badge" style="font-size: 1.25rem; padding: 1rem 1.5rem; margin-bottom: 1rem; display: inline-block;">
                                <span>--</span>
                            </div>
                            <div style="color: var(--text-muted); margin-top: 1rem;">
                                <div style="font-size: 0.875rem; margin-bottom: 0.5rem;">Regime Scale Multiplier</div>
                                <div id="regimeScale" style="font-size: 1.75rem; font-weight: 700; color: var(--blue);">--</div>
                            </div>
                        </div>
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.08);">
                            <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.75rem;">Volatility Guard</div>
                            <div id="volatilityGuard" class="volatility-guard-bar"></div>
                            <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">
                                <span id="vrCurrent">VR: --</span>
                                <span id="vrThreshold">Min: 0.88</span>
                            </div>
                            </div>
                        </div>
                    </div>

                <!-- Decision Logic Radar -->
                <div class="st-glass-card" style="margin-bottom: 1.5rem;">
                    <h2 class="st-card-header" style="margin: 0 0 0.5rem; font-size: 1.25rem; font-weight: 600;">Decision Logic Composition</h2>
                    <p class="command-subtitle" style="margin: 0 0 1.5rem;">How the bot is currently thinking (Dynamic Weights)</p>
                    <div id="decisionLogicRadar" class="chart-container"></div>
                    </div>

                <!-- Advanced VSA Charting -->
                <div class="st-glass-card" style="margin-bottom: 1.5rem;">
                    <h2 class="st-card-header" style="margin: 0 0 0.5rem; font-size: 1.25rem; font-weight: 600;">Advanced VSA Charting</h2>
                    <p class="command-subtitle" style="margin: 0 0 1.5rem;">Price action with Whale Footprints (Absorption/Distribution markers)</p>
                    <div id="vsaCandlestickChart" class="chart-container"></div>
                    <div style="margin-top: 1rem;">
                        <h3 style="margin: 0 0 0.75rem; font-size: 1rem; font-weight: 600;">Relative Volume (RVOL)</h3>
                        <div id="rvolChart" class="chart-container-small"></div>
                            </div>
                        </div>
                    </div>

            <!-- Right Column: Live Reasoning Timeline -->
            <div>
                <div class="st-glass-card" style="position: sticky; top: 2rem;">
                    <h2 class="st-card-header" style="margin: 0 0 0.5rem; font-size: 1.25rem; font-weight: 600;">Live Reasoning Timeline</h2>
                    <p class="command-subtitle" style="margin: 0 0 1.5rem;">Real-time decision reasoning and alerts</p>
                    <div id="reasoningTimeline" class="reasoning-timeline">
                            <div style="text-align: center; color: var(--text-muted); padding: 2rem;">Loading...</div>
                        </div>
                    </div>
            </div>
        </div>

        <footer class="st-footer" style="margin-top: 3rem;">
            <span>SmartTrader ¬© 2025</span>
            <span>Quantiviq ‚Ä¢ Algorithmic Research</span>
        </footer>
    </div>

    <script>
        let whaleBiasGaugeChart = null;
        let whaleFlowChart = null;
        let decisionLogicRadarChart = null;
        let vsaCandlestickChart = null;
        let rvolChart = null;

        // Get responsive chart height
        function getChartHeight(small = false) {
            if (window.innerWidth < 768) {
                return small ? 200 : 300;
            } else if (window.innerWidth < 1024) {
                return small ? 250 : 400;
            }
            return small ? 250 : 450;
        }

        async function loadCommandCenter() {
            try {
                const response = await fetch('/api/insights/command-center');
                const data = await response.json();

                if (data.error) {
                    console.error('Command center error:', data.error);
                    return;
                }

                // Update Whale Sentiment
                updateWhaleSentiment(data.whale_bias || 0.0, data.vsa_signal || "NO_DATA", data.whale_bias_history || []);
                
                // Update Supply vs Demand Indicator
                updateSupplyDemandIndicator(data.supply_overcoming_demand || false, data.vsa_signal || "NO_DATA");
                
                // Update Market Regime Dashboard
                updateRegimeDashboard(data.current_regime || "NEUTRAL", data.regime_scale || 1.0);
                
                // Update Volatility Guard
                updateVolatilityGuard(data.volatility_ratio || 1.0, data.min_vr_trade || 0.88);
                
                // Update Decision Logic Radar
                updateDecisionLogicRadar(data.confluence_factors || {}, data.dynamic_weights || {});
                
                // Update VSA Candlestick Charting
                updateVSACandlestickChart(data.price_history || [], data.rvol_history || [], data.avg_rvol || 1.0);
                
                // Update Live Reasoning Timeline
                updateReasoningTimeline(data.reasons || [], data.latest_decision || {}, data.whale_bias || 0.0, data.supply_overcoming_demand || false);
                
            } catch (err) {
                console.error('Command center load error:', err);
            }
        }

        function updateWhaleSentiment(whaleBias, vsaSignal, whaleBiasHistory) {
            // Gauge Chart
            const gaugeValue = ((whaleBias + 1.0) / 2.0) * 100;
            const chartHeight = getChartHeight(true);
            
            const gaugeOptions = {
                series: [gaugeValue],
                chart: {
                    type: 'radialBar',
                    height: chartHeight,
                    width: '100%',
                },
                plotOptions: {
                    radialBar: {
                        startAngle: -90,
                        endAngle: 90,
                        track: {
                            background: '#334155',
                            strokeWidth: '97%',
                            margin: 5,
                        },
                        dataLabels: {
                            name: {
                                show: true,
                                fontSize: window.innerWidth < 768 ? '12px' : '14px',
                                fontWeight: 600,
                                color: '#94a3b8',
                                offsetY: -10,
                            },
                            value: {
                                show: true,
                                fontSize: window.innerWidth < 768 ? '20px' : '24px',
                                fontWeight: 700,
                                color: whaleBias > 0 ? '#10b981' : whaleBias < 0 ? '#ef4444' : '#94a3b8',
                                offsetY: 12,
                                formatter: function(val) {
                                    return whaleBias.toFixed(3);
                                }
                            }
                        }
                    }
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shade: 'dark',
                        type: 'horizontal',
                        shadeIntensity: 0.5,
                        gradientToColors: whaleBias > 0 ? ['#10b981'] : ['#ef4444'],
                        inverseColors: true,
                        opacityFrom: 1,
                        opacityTo: 1,
                        stops: [0, 100]
                    }
                },
                labels: ['Whale Bias'],
                colors: whaleBias > 0 ? ['#10b981'] : whaleBias < 0 ? ['#ef4444'] : ['#94a3b8'],
            };

            if (whaleBiasGaugeChart) {
                whaleBiasGaugeChart.updateOptions(gaugeOptions);
            } else {
                whaleBiasGaugeChart = new ApexCharts(document.querySelector("#whaleBiasGauge"), gaugeOptions);
                whaleBiasGaugeChart.render();
            }

            // Flow Chart (Area Chart)
            if (whaleBiasHistory && whaleBiasHistory.length > 0) {
                const flowData = whaleBiasHistory.map(h => ({
                    x: new Date(h.timestamp).getTime(),
                    y: h.whale_bias
                }));

                const flowOptions = {
                    series: [{
                        name: 'Whale Bias Flow',
                        data: flowData,
                    }],
                    chart: {
                        type: 'area',
                        height: chartHeight,
                        width: '100%',
                        toolbar: { show: false },
                    },
                    stroke: {
                        width: 2,
                        curve: 'smooth',
                    },
                    fill: {
                        type: 'gradient',
                        gradient: {
                            shade: 'dark',
                            type: 'vertical',
                            shadeIntensity: 0.5,
                            gradientToColors: ['#3b82f6'],
                            inverseColors: false,
                            opacityFrom: 0.4,
                            opacityTo: 0.1,
                        }
                    },
                    xaxis: {
                        type: 'datetime',
                        labels: {
                            style: {
                                colors: '#94a3b8',
                                fontSize: window.innerWidth < 768 ? '9px' : '10px',
                            }
                        }
                    },
                    yaxis: {
                        min: -1,
                        max: 1,
                        labels: {
                            style: {
                                colors: '#94a3b8',
                                fontSize: window.innerWidth < 768 ? '9px' : '10px',
                            }
                        }
                    },
                    colors: ['#3b82f6'],
                    tooltip: {
                        y: {
                            formatter: function(val) {
                                return val.toFixed(3);
                            }
                        }
                    },
                };

                if (whaleFlowChart) {
                    whaleFlowChart.updateOptions(flowOptions);
                    whaleFlowChart.updateSeries([{
                        name: 'Whale Bias Flow',
                        data: flowData,
                    }]);
                } else {
                    whaleFlowChart = new ApexCharts(document.querySelector("#whaleFlowChart"), flowOptions);
                    whaleFlowChart.render();
                }
            }

            // Whale Activity Heat Gradient
            const activityLevel = ((whaleBias + 1.0) / 2.0) * 100; // 0-100%
            const heatEl = document.getElementById('whaleActivityHeat');
            if (heatEl) {
                heatEl.innerHTML = `<div class="whale-activity-marker" style="left: ${activityLevel}%;"></div>`;
            }
        }

        function updateSupplyDemandIndicator(supplyOvercoming, vsaSignal) {
            const indicatorEl = document.getElementById('supplyDemandIndicator');
            if (!indicatorEl) return;

            let status, text, className;
            if (supplyOvercoming) {
                status = '‚ö†Ô∏è';
                text = 'Supply Overcoming Demand';
                className = 'supply-overcoming';
            } else if (vsaSignal === 'ABSORPTION') {
                status = '‚úÖ';
                text = 'Demand Dominant';
                className = 'demand-dominant';
            } else {
                status = '‚öñÔ∏è';
                text = 'Balanced';
                className = 'balanced';
            }

            indicatorEl.innerHTML = `
                <div class="supply-demand-indicator ${className}">
                    <span>${status}</span>
                    <span>${text}</span>
                    <span style="font-size: 0.75rem; opacity: 0.8;">(${vsaSignal})</span>
                </div>
            `;
        }

        function updateRegimeDashboard(regime, regimeScale) {
            const badgeEl = document.getElementById('regimeBadge');
            const scaleEl = document.getElementById('regimeScale');
            
            if (badgeEl) {
                badgeEl.innerHTML = `<span>${regime}</span>`;
                badgeEl.className = `regime-badge regime-${regime.toLowerCase()}`;
                badgeEl.style.fontSize = window.innerWidth < 768 ? '1rem' : '1.25rem';
                badgeEl.style.padding = window.innerWidth < 768 ? '0.75rem 1rem' : '1rem 1.5rem';
            }
            
            if (scaleEl) {
                scaleEl.textContent = `√ó${regimeScale.toFixed(2)}`;
                scaleEl.style.fontSize = window.innerWidth < 768 ? '1.5rem' : '1.75rem';
            }
        }

        function updateVolatilityGuard(vr, minVr) {
            const guardEl = document.getElementById('volatilityGuard');
            const vrCurrentEl = document.getElementById('vrCurrent');
            const vrThresholdEl = document.getElementById('vrThreshold');
            
            if (guardEl) {
                const percentage = Math.min(100, (vr / minVr) * 100);
                const color = vr >= minVr ? '#10b981' : '#ef4444';
                
                guardEl.innerHTML = `
                    <div class="volatility-guard-fill" style="width: ${percentage}%; background: ${color};"></div>
                `;
            }
            
            if (vrCurrentEl) {
                vrCurrentEl.textContent = `VR: ${vr.toFixed(2)}`;
                vrCurrentEl.style.color = vr >= minVr ? '#10b981' : '#ef4444';
            }
            
            if (vrThresholdEl) {
                vrThresholdEl.textContent = `Min: ${minVr.toFixed(2)}`;
            }
        }

        function updateDecisionLogicRadar(confluenceFactors, dynamicWeights) {
            const categories = ['Trend', 'Momentum', 'MeanRev', 'Breakout'];
            const values = [
                Math.abs(confluenceFactors.trend || 0) * 100,
                Math.abs(confluenceFactors.momentum || 0) * 100,
                Math.abs(confluenceFactors.meanrev || 0) * 100,
                Math.abs(confluenceFactors.breakout || 0) * 100,
            ];

            const chartHeight = getChartHeight();

            const options = {
                series: [{
                    name: 'Signal Strength',
                    data: values,
                }],
                chart: {
                    type: 'radar',
                    height: chartHeight,
                    width: '100%',
                    toolbar: { show: false },
                },
                xaxis: {
                    categories: categories,
                },
                yaxis: {
                    max: 100,
                    min: 0,
                },
                fill: {
                    opacity: 0.3,
                    colors: ['#3b82f6'],
                },
                stroke: {
                    colors: ['#3b82f6'],
                    width: 2,
                },
                markers: {
                    size: 4,
                    colors: ['#3b82f6'],
                },
                plotOptions: {
                    radar: {
                        polygons: {
                            strokeColors: '#475569',
                            fill: {
                                colors: ['#1e293b', '#334155']
                            }
                        }
                    }
                },
                tooltip: {
                    y: {
                        formatter: function(val) {
                            return val.toFixed(1) + '%';
                        }
                    }
                },
            };

            if (decisionLogicRadarChart) {
                decisionLogicRadarChart.updateOptions(options);
            } else {
                decisionLogicRadarChart = new ApexCharts(document.querySelector("#decisionLogicRadar"), options);
                decisionLogicRadarChart.render();
            }
        }

        function updateVSACandlestickChart(priceHistory, rvolHistory, avgRvol) {
            if (!priceHistory || priceHistory.length === 0) {
                const chartEl = document.getElementById('vsaCandlestickChart');
                if (chartEl) {
                    chartEl.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">No price data available.</div>';
                }
                return;
            }

            // Prepare price line data
            const priceData = priceHistory.map(c => ({
                x: new Date(c.timestamp).getTime(),
                y: c.price
            }));

            // Prepare volume data with color coding and highlight high RVOL
            const volumeData = priceHistory.map((c, idx) => {
                const isUp = c.price >= (c.open || c.price);
                const rvol = rvolHistory[idx]?.rvol || 1.0;
                const fillColor = rvol > 2.0 ? '#f59e0b' : (isUp ? '#10b981' : '#ef4444');
                return {
                    x: new Date(c.timestamp).getTime(),
                    y: c.volume || 0,
                    fillColor: fillColor,
                };
            });

            // Find VSA annotations (Absorption/Distribution)
            const annotations = {
                points: []
            };

            priceHistory.forEach((candle) => {
                const timestamp = new Date(candle.timestamp).getTime();
                if (candle.vsa_signal === 'ABSORPTION') {
                    annotations.points.push({
                        x: timestamp,
                        y: candle.high || candle.price,
                        marker: {
                            size: window.innerWidth < 768 ? 10 : 12,
                            fillColor: '#10b981',
                            strokeColor: '#ffffff',
                            strokeWidth: 2,
                            shape: 'circle',
                        },
                        label: {
                            text: 'üêã',
                            style: {
                                color: '#10b981',
                                fontSize: window.innerWidth < 768 ? '14px' : '16px',
                            },
                            offsetY: -20,
                        }
                    });
                } else if (candle.vsa_signal === 'DISTRIBUTION') {
                    annotations.points.push({
                        x: timestamp,
                        y: candle.high || candle.price,
                        marker: {
                            size: window.innerWidth < 768 ? 10 : 12,
                            fillColor: '#ef4444',
                            strokeColor: '#ffffff',
                            strokeWidth: 2,
                            shape: 'circle',
                        },
                        label: {
                            text: '‚ö°',
                            style: {
                                color: '#ef4444',
                                fontSize: window.innerWidth < 768 ? '14px' : '16px',
                            },
                            offsetY: -20,
                        }
                    });
                }
            });

            const chartHeight = getChartHeight();

            const options = {
                series: [{
                    name: 'Price',
                    type: 'line',
                    data: priceData,
                }, {
                    name: 'Volume',
                    type: 'column',
                    data: volumeData,
                }],
                chart: {
                    type: 'line',
                    height: chartHeight,
                    width: '100%',
                    toolbar: { show: true },
                    zoom: { enabled: true },
                },
                stroke: {
                    width: 2,
                    curve: 'smooth',
                    colors: ['#3b82f6'],
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shade: 'dark',
                        type: 'vertical',
                        shadeIntensity: 0.5,
                        gradientToColors: ['#3b82f6'],
                        inverseColors: false,
                        opacityFrom: 0.3,
                        opacityTo: 0.1,
                    }
                },
                plotOptions: {
                    bar: {
                        columnWidth: '60%',
                        colors: {
                            ranges: volumeData.map(d => ({
                                from: d.x,
                                to: d.x,
                                color: d.fillColor
                            }))
                        }
                    }
                },
                annotations: annotations,
                xaxis: {
                    type: 'datetime',
                    labels: {
                        style: {
                            colors: '#94a3b8',
                            fontSize: window.innerWidth < 768 ? '10px' : '12px',
                        }
                    }
                },
                yaxis: [{
                    title: {
                        text: 'Price',
                        style: {
                            color: '#94a3b8',
                        }
                    },
                    labels: {
                        style: {
                            colors: '#94a3b8',
                            fontSize: window.innerWidth < 768 ? '10px' : '12px',
                        },
                        formatter: function(val) {
                            return val.toLocaleString();
                        }
                    }
                }, {
                    opposite: true,
                    title: {
                        text: 'Volume',
                        style: {
                            color: '#94a3b8',
                        }
                    },
                    labels: {
                        style: {
                            colors: '#94a3b8',
                            fontSize: window.innerWidth < 768 ? '10px' : '12px',
                        }
                    }
                }],
                tooltip: {
                    shared: true,
                    intersect: false,
                },
                colors: ['#3b82f6', '#10b981'],
                legend: {
                    show: true,
                    position: 'top',
                    labels: {
                        colors: '#94a3b8',
                    }
                },
            };

            if (vsaCandlestickChart) {
                vsaCandlestickChart.updateOptions(options);
                vsaCandlestickChart.updateSeries([{
                    name: 'Price',
                    type: 'line',
                    data: priceData,
                }, {
                    name: 'Volume',
                    type: 'column',
                    data: volumeData,
                }]);
            } else {
                vsaCandlestickChart = new ApexCharts(document.querySelector("#vsaCandlestickChart"), options);
                vsaCandlestickChart.render();
            }

            // Update RVOL Chart
            if (rvolHistory && rvolHistory.length > 0) {
                const rvolData = rvolHistory.map(r => ({
                    x: new Date(r.timestamp).getTime(),
                    y: r.rvol
                }));
                const avgRvolData = rvolHistory.map(r => ({
                    x: new Date(r.timestamp).getTime(),
                    y: avgRvol
                }));

                const rvolHeight = getChartHeight(true);

                const rvolOptions = {
                    series: [{
                        name: 'RVOL',
                        data: rvolData,
                    }, {
                        name: 'Avg RVOL',
                        data: avgRvolData,
                        type: 'line',
                    }],
                    chart: {
                        type: 'bar',
                        height: rvolHeight,
                        width: '100%',
                        toolbar: { show: false },
                    },
                    plotOptions: {
                        bar: {
                            colors: {
                                ranges: [{
                                    from: 0,
                                    to: 2,
                                    color: '#3b82f6'
                                }, {
                                    from: 2,
                                    to: 100,
                                    color: '#f59e0b'
                                }]
                            }
                        }
                    },
                    stroke: {
                        width: 2,
                        curve: 'smooth',
                    },
                    fill: {
                        type: 'gradient',
                        gradient: {
                            shade: 'dark',
                            type: 'vertical',
                            shadeIntensity: 0.5,
                            gradientToColors: ['#3b82f6'],
                            inverseColors: false,
                            opacityFrom: 0.3,
                            opacityTo: 0.1,
                        }
                    },
                    xaxis: {
                        type: 'datetime',
                        labels: {
                            style: {
                                colors: '#94a3b8',
                                fontSize: window.innerWidth < 768 ? '9px' : '10px',
                            }
                        }
                    },
                    yaxis: {
                        labels: {
                            style: {
                                colors: '#94a3b8',
                                fontSize: window.innerWidth < 768 ? '9px' : '10px',
                            },
                        }
                    },
                    colors: ['#3b82f6', '#94a3b8'],
                    legend: {
                        show: true,
                        position: 'top',
                        labels: {
                            colors: '#94a3b8',
                        }
                    },
                    tooltip: {
                        shared: true,
                        intersect: false,
                    },
                };

                if (rvolChart) {
                    rvolChart.updateOptions(rvolOptions);
                    rvolChart.updateSeries([{
                        name: 'RVOL',
                        data: rvolData,
                    }, {
                        name: 'Avg RVOL',
                        data: avgRvolData,
                        type: 'line',
                    }]);
                } else {
                    rvolChart = new ApexCharts(document.querySelector("#rvolChart"), rvolOptions);
                    rvolChart.render();
                }
            }
        }

        function updateReasoningTimeline(reasons, latestDecision, whaleBias, supplyOvercoming) {
            const timelineEl = document.getElementById('reasoningTimeline');
            if (!timelineEl) return;

            if (!reasons || reasons.length === 0) {
                timelineEl.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">No reasoning data available.</div>';
                    return;
            }

            let html = '';
            
            // Add decision summary
            if (latestDecision.decision) {
                const decisionClass = latestDecision.decision === 'BUY' ? 'success' : 
                                     latestDecision.decision === 'SELL' ? 'danger' : 'warning';
                html += `
                    <div class="reasoning-timeline-item ${decisionClass}">
                        <strong>Decision: ${latestDecision.decision}</strong><br>
                        Aggregate S: ${(latestDecision.aggregate_s || 0).toFixed(3)} | 
                        Price: ${(latestDecision.price || 0).toLocaleString()}
                    </div>
                `;
            }

            // Add reasons with highlighting
            reasons.forEach((reason) => {
                let itemClass = '';
                let highlightedReason = reason;
                
                // Highlight key terms
                const highlightTerms = ['WHALE_GATE', 'VOL_GUARD', 'conflict', 'supply overcoming', 'HOLD', 'gated'];
                highlightTerms.forEach(term => {
                    const regex = new RegExp(`(${term})`, 'gi');
                    highlightedReason = highlightedReason.replace(regex, '<span class="highlight">$1</span>');
                });
                
                if (reason.includes('WHALE_GATE') || reason.includes('supply overcoming')) {
                    itemClass = 'danger';
                } else if (reason.includes('BUY') || reason.includes('SELL')) {
                    itemClass = 'success';
                } else if (reason.includes('HOLD') || reason.includes('gated') || reason.includes('VOL_GUARD')) {
                    itemClass = 'warning';
                }

                html += `
                    <div class="reasoning-timeline-item ${itemClass}">
                        ${highlightedReason}
                        </div>
                `;
            });

            // Add whale gate explanation if applicable
            if (supplyOvercoming && latestDecision.decision === 'HOLD') {
                html += `
                    <div class="reasoning-timeline-item danger">
                        <strong>üêã Whale Gate Activated:</strong><br>
                        Despite bullish trend signals, VSA analysis indicates supply overcoming demand 
                        (whale_bias: ${whaleBias.toFixed(3)}). Trade held to avoid bull trap.
                    </div>
                `;
            }

            timelineEl.innerHTML = html;
        }

        // Handle window resize for responsive charts
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                if (whaleBiasGaugeChart) whaleBiasGaugeChart.updateOptions({ chart: { height: getChartHeight(true) } });
                if (whaleFlowChart) whaleFlowChart.updateOptions({ chart: { height: getChartHeight(true) } });
                if (decisionLogicRadarChart) decisionLogicRadarChart.updateOptions({ chart: { height: getChartHeight() } });
                if (vsaCandlestickChart) vsaCandlestickChart.updateOptions({ chart: { height: getChartHeight() } });
                if (rvolChart) rvolChart.updateOptions({ chart: { height: getChartHeight(true) } });
            }, 250);
        });

        // Initial load
        loadCommandCenter();

        // Auto-refresh every 15 seconds
        setInterval(loadCommandCenter, 15000);
    </script>
</body>
</html>
