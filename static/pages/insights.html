<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Market Intelligence – SmartTrader</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="st-body">
    <script src="/static/js/nav.js"></script>
    <div class="st-page">
        <!-- Intelligence Header -->
        <header class="st-glass-card" style="margin: 2rem 0; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <h1 style="margin: 0 0 0.5rem; font-size: 1.75rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem;">
                    Market Intelligence Dashboard
                    <span class="st-status-dot st-status-dot-active" style="margin-right: 0.5rem;"></span>
                </h1>
                <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">Real-time Market DNA Analysis</p>
            </div>
            <div style="text-align: left;">
                <div id="liveStatus" style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                    <span class="st-status-dot st-status-dot-active"></span>
                    <span>Bot Active</span>
                </div>
            </div>
        </header>

        <!-- 2-Column High-Density Layout -->
        <div class="st-main">
            <section class="st-row st-row-responsive">
                <!-- LEFT SIDEBAR: Technical Pulse -->
                <aside class="st-card st-side-panel" style="min-width: 320px;">
                    <!-- Market Health Gauges -->
                    <div class="st-panel-block">
                        <div class="st-panel-title">Market Health Gauges</div>
                        <div class="st-panel-subtitle">Real-time Technical Pulse</div>

                        <!-- Behavior Score Gauge -->
                        <div style="margin: 1.5rem 0;">
                            <div style="text-align: center; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Behavior Score</div>
                            <div class="st-gauge-container" id="gaugeBehavior">
                                <svg class="st-gauge-svg" viewBox="0 0 200 120">
                                    <path class="st-gauge-track" d="M 20 100 A 80 80 0 0 1 180 100" />
                                    <path id="gaugeBehaviorFill" class="st-gauge-fill" d="M 20 100 A 80 80 0 0 1 180 100" />
                                </svg>
                                <div id="gaugeBehaviorValue" class="st-gauge-value">--</div>
                                <div class="st-gauge-label">Whale Proxies</div>
                            </div>
                        </div>

                        <!-- Trend Strength (ADX) Gauge -->
                        <div style="margin: 1.5rem 0;">
                            <div style="text-align: center; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Trend Strength (ADX)</div>
                            <div class="st-gauge-container" id="gaugeTrend">
                                <svg class="st-gauge-svg" viewBox="0 0 200 120">
                                    <path class="st-gauge-track" d="M 20 100 A 80 80 0 0 1 180 100" />
                                    <path id="gaugeTrendFill" class="st-gauge-fill" d="M 20 100 A 80 80 0 0 1 180 100" />
                                </svg>
                                <div id="gaugeTrendValue" class="st-gauge-value">--</div>
                                <div class="st-gauge-label">ADX</div>
                            </div>
                        </div>

                        <!-- Volatility Shift (ATR) Gauge -->
                        <div style="margin: 1.5rem 0;">
                            <div style="text-align: center; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Volatility Shift</div>
                            <div class="st-gauge-container" id="gaugeVolatility">
                                <svg class="st-gauge-svg" viewBox="0 0 200 120">
                                    <path class="st-gauge-track" d="M 20 100 A 80 80 0 0 1 180 100" />
                                    <path id="gaugeVolatilityFill" class="st-gauge-fill" d="M 20 100 A 80 80 0 0 1 180 100" />
                                </svg>
                                <div id="gaugeVolatilityValue" class="st-gauge-value">--</div>
                                <div class="st-gauge-label">ATR Ratio</div>
                            </div>
                        </div>
                    </div>

                    <!-- Live Bot Decision Status -->
                    <div class="st-panel-block">
                        <div class="st-panel-title">Live Bot Status</div>
                        <div id="botStatus" style="font-size: 0.85rem; line-height: 1.8;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(148,163,178,0.1);">
                                <span style="color: var(--text-muted);">Last Decision:</span>
                                <span id="lastDecision" style="font-weight: 600;">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(148,163,178,0.1);">
                                <span style="color: var(--text-muted);">Regime:</span>
                                <span id="currentRegime" style="font-weight: 600;">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                <span style="color: var(--text-muted);">Aggregate S:</span>
                                <span id="aggregateS" style="font-weight: 600;">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Momentum Sparkline -->
                    <div class="st-panel-block">
                        <div class="st-panel-title">24h Price Momentum</div>
                        <div class="st-panel-subtitle">BTC/TMN Trend</div>
                        <canvas id="momentumSparkline" style="width: 100%; height: 80px; margin-top: 0.5rem;"></canvas>
                    </div>
                </aside>

                <!-- RIGHT MAIN: Quantitative Reports + Insights -->
                <main style="flex: 1;">
                    <!-- Whale Tracker Radar -->
                    <div class="st-card" style="margin-bottom: 1.5rem;">
                        <div class="st-card-header">
                            <h2>Whale Tracker Radar</h2>
                            <p class="st-card-caption">Automated Intelligence Alerts</p>
                        </div>
                        <div id="whaleRadar" style="max-height: 300px; overflow-y: auto; padding: 1rem 0;">
                            <div style="text-align: center; color: var(--text-muted); padding: 2rem;">در حال بارگذاری...</div>
                        </div>
                    </div>

                    <!-- Quantitative Reports -->
                    <div class="st-card" style="margin-bottom: 1.5rem;">
                        <div class="st-card-header">
                            <h2>Quantitative Reports</h2>
                            <p class="st-card-caption">Market DNA Analysis</p>
                        </div>
                        <div id="quantitativeReports" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; padding: 1rem 0;">
                            <div style="padding: 1rem; background: var(--bg-soft); border-radius: var(--radius-sm); border-left: 3px solid var(--blue);">
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">ADX Latest</div>
                                <div id="reportAdx" style="font-size: 1.5rem; font-weight: 700;">--</div>
                            </div>
                            <div style="padding: 1rem; background: var(--bg-soft); border-radius: var(--radius-sm); border-left: 3px solid var(--yellow);">
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">ATR Latest</div>
                                <div id="reportAtr" style="font-size: 1.5rem; font-weight: 700;">--</div>
                            </div>
                            <div style="padding: 1rem; background: var(--bg-soft); border-radius: var(--radius-sm); border-left: 3px solid var(--green);">
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Volatility Shift</div>
                                <div id="reportVolShift" style="font-size: 1.5rem; font-weight: 700;">--</div>
                            </div>
                            <div style="padding: 1rem; background: var(--bg-soft); border-radius: var(--radius-sm); border-left: 3px solid var(--blue);">
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Regime Distribution</div>
                                <div id="reportRegime" style="font-size: 0.9rem; font-weight: 600;">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- Human Insights Feed -->
                    <div class="st-card">
                        <div class="st-card-header">
                            <h2>Human Insights</h2>
                            <p class="st-card-caption">Published Analysis & News</p>
                        </div>
                        <div id="insightsList" style="padding: 1rem 0;">
                            <div style="text-align: center; color: var(--text-muted); padding: 2rem;">در حال بارگذاری...</div>
                        </div>
                    </div>
                </main>
            </section>
        </div>

        <footer class="st-footer">
            <span>SmartTrader © 2025</span>
            <span>Quantiviq • Algorithmic Research</span>
        </footer>
    </div>

    <script>
        let sparklineChart = null;

        function updateGauge(gaugeId, fillId, valueId, score, colorClass) {
            const fill = document.getElementById(fillId);
            const value = document.getElementById(valueId);
            if (!fill || !value) return;

            const percentage = Math.min(100, Math.max(0, score));
            const offset = 314 * (1 - percentage / 100);
            
            fill.setAttribute('stroke-dashoffset', offset);
            fill.className = `st-gauge-fill ${colorClass}`;
            value.textContent = score.toFixed(1);
            
            const color = colorClass === 'st-gauge-fill-high' ? 'var(--green)' : 
                         colorClass === 'st-gauge-fill-medium' ? 'var(--yellow)' : 'var(--red)';
            value.style.color = color;
        }

        function renderSparkline(history) {
            const canvas = document.getElementById('momentumSparkline');
            if (!canvas || !history || history.length < 2) return;

            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;

            ctx.clearRect(0, 0, w, h);

            const prices = history.map(h => Number(h.price));
            const min = Math.min(...prices);
            const max = Math.max(...prices);
            const range = max - min || 1;
            const stepX = w / (prices.length - 1);

            // Gradient fill
            const gradient = ctx.createLinearGradient(0, 0, 0, h);
            gradient.addColorStop(0, 'rgba(96, 165, 250, 0.3)');
            gradient.addColorStop(1, 'rgba(96, 165, 250, 0)');

            ctx.beginPath();
            ctx.moveTo(0, h);
            prices.forEach((p, i) => {
                const x = i * stepX;
                const y = h - ((p - min) / range) * h;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.lineTo(w, h);
            ctx.closePath();
            ctx.fillStyle = gradient;
            ctx.fill();

            // Line
            ctx.beginPath();
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#60a5fa';
            prices.forEach((p, i) => {
                const x = i * stepX;
                const y = h - ((p - min) / range) * h;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
        }

        async function loadBehaviorData() {
            try {
                const behavior = await fetch('/api/market/behavior?symbol=BTC').then(r => r.json());
                if (behavior) {
                    const score = behavior.behavior_score || 0;
                    const colorClass = score > 70 ? 'st-gauge-fill-high' : score > 40 ? 'st-gauge-fill-medium' : 'st-gauge-fill-low';
                    updateGauge('gaugeBehavior', 'gaugeBehaviorFill', 'gaugeBehaviorValue', score, colorClass);

                    // Whale Radar
                    const explanations = behavior.explanations || [];
                    const radarEl = document.getElementById('whaleRadar');
                    if (radarEl) {
                        if (explanations.length === 0) {
                            radarEl.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">هیچ هشداری در حال حاضر وجود ندارد.</div>';
                        } else {
                            radarEl.innerHTML = explanations.map((e, i) => {
                                const isPositive = e.toLowerCase().includes('increase') || e.toLowerCase().includes('high');
                                const borderColor = isPositive ? 'var(--green)' : 'var(--blue)';
                                return `
                                    <div style="padding: 1rem; margin: 0.5rem 0; background: var(--bg-soft); border-radius: var(--radius-sm); border-left: 3px solid ${borderColor}; display: flex; align-items: start; gap: 0.75rem;">
                                        <span style="color: ${borderColor}; font-size: 1.2rem;">⚡</span>
                                        <div style="flex: 1; font-size: 0.9rem; line-height: 1.6;">${e}</div>
                                    </div>
                                `;
                            }).join('');
                        }
                    }
                }
            } catch (err) {
                console.error('Behavior data error:', err);
            }
        }

        async function loadIntelligenceSummary() {
            try {
                const summary = await fetch('/api/intelligence/summary').then(r => r.json());
                if (summary) {
                    // Trend Strength (ADX) Gauge
                    const trendStrength = summary.trend_strength || 0;
                    const trendColorClass = trendStrength > 70 ? 'st-gauge-fill-high' : trendStrength > 40 ? 'st-gauge-fill-medium' : 'st-gauge-fill-low';
                    updateGauge('gaugeTrend', 'gaugeTrendFill', 'gaugeTrendValue', trendStrength, trendColorClass);

                    // Volatility Shift Gauge (normalize to 0-100)
                    const volShift = Math.min(100, Math.max(0, 50 + (summary.volatility_shift || 0)));
                    const volColorClass = volShift > 60 ? 'st-gauge-fill-high' : volShift > 40 ? 'st-gauge-fill-medium' : 'st-gauge-fill-low';
                    updateGauge('gaugeVolatility', 'gaugeVolatilityFill', 'gaugeVolatilityValue', volShift, volColorClass);

                    // Quantitative Reports
                    document.getElementById('reportAdx').textContent = summary.adx_latest?.toFixed(1) || '--';
                    document.getElementById('reportAtr').textContent = summary.atr_latest?.toFixed(2) || '--';
                    document.getElementById('reportVolShift').textContent = 
                        (summary.volatility_shift >= 0 ? '+' : '') + summary.volatility_shift?.toFixed(1) + '%' || '--';
                    
                    const regimeDist = summary.regime_distribution || {};
                    const regimeText = Object.entries(regimeDist).map(([k, v]) => `${k}: ${v}`).join(' | ') || '--';
                    document.getElementById('reportRegime').textContent = regimeText;

                    // Bot Status
                    document.getElementById('lastDecision').textContent = summary.latest_decision || '--';
                    document.getElementById('currentRegime').textContent = summary.latest_regime || '--';
                }
            } catch (err) {
                console.error('Intelligence summary error:', err);
            }
        }

        async function loadLatestDecision() {
            try {
                const decisions = await fetch('/api/decisions?limit=1').then(r => r.json());
                if (decisions && decisions.length > 0) {
                    const last = decisions[0];
                    document.getElementById('lastDecision').textContent = last.decision || '--';
                    document.getElementById('currentRegime').textContent = last.regime || '--';
                    document.getElementById('aggregateS').textContent = last.aggregate_s?.toFixed(3) || '--';
                }
            } catch (err) {
                console.error('Latest decision error:', err);
            }
        }

        async function loadMomentumSparkline() {
            try {
                const btc = await fetch('/api/btc_price').then(r => r.json());
                if (btc && Array.isArray(btc.history)) {
                    renderSparkline(btc.history);
                }
            } catch (err) {
                console.error('Sparkline error:', err);
            }
        }

        async function loadInsights() {
            const container = document.getElementById('insightsList');
            try {
                const res = await fetch('/api/insights/feed?limit=10');
                const insights = await res.json();

                if (!insights || insights.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">هنوز تحلیلی منتشر نشده است.</div>';
                    return;
                }

                container.innerHTML = insights.map(insight => `
                    <div class="st-glass-card" style="margin: 1rem 0; padding: 1.5rem;">
                        <h3 style="margin-bottom: 0.5rem; font-size: 1.1rem;">${insight.title || 'بدون عنوان'}</h3>
                        <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem; display: flex; gap: 1rem;">
                            ${insight.created_at ? `<span>${new Date(insight.created_at).toLocaleDateString('fa-IR')}</span>` : ''}
                            ${insight.sentiment ? `<span class="st-status-badge ${insight.sentiment === 'POSITIVE' ? 'st-status-badge-active' : insight.sentiment === 'NEGATIVE' ? 'st-status-badge-pending' : ''}">${insight.sentiment}</span>` : ''}
                        </div>
                        <p style="color: var(--text-muted); line-height: 1.6;">${insight.summary || 'خلاصه در دسترس نیست'}</p>
                    </div>
                `).join('');
            } catch (err) {
                container.innerHTML = '<div style="text-align: center; color: var(--red); padding: 2rem;">خطا در بارگذاری تحلیل‌ها</div>';
            }
        }

        // Initial load
        loadBehaviorData();
        loadIntelligenceSummary();
        loadLatestDecision();
        loadMomentumSparkline();
        loadInsights();

        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadBehaviorData();
            loadIntelligenceSummary();
            loadLatestDecision();
            loadMomentumSparkline();
        }, 30000);
    </script>
</body>
</html>
