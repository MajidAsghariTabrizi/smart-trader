<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <title>Command Center ‚Äì SmartTrader</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #131829;
            --bg-tertiary: #1a1f35;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --border-color: #1e293b;
        }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .command-center-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .regime-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .regime-low { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .regime-neutral { background: rgba(148, 163, 178, 0.2); color: #94a3b8; border: 1px solid rgba(148, 163, 178, 0.3); }
        .regime-high { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }
        
        .supply-demand-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .supply-overcoming { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }
        .demand-dominant { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }
        .balanced { background: rgba(148, 163, 178, 0.2); color: #94a3b8; border: 1px solid rgba(148, 163, 178, 0.3); }
        
        .logic-feed-item {
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: var(--bg-tertiary);
            border-left: 3px solid var(--accent-blue);
            border-radius: 4px;
            font-size: 0.875rem;
            line-height: 1.6;
        }
        
        .logic-feed-item.warning { border-left-color: var(--accent-yellow); }
        .logic-feed-item.danger { border-left-color: var(--accent-red); }
        .logic-feed-item.success { border-left-color: var(--accent-green); }
        
        .whale-footprint {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
        }
        
        .footprint-absorption { background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green); }
        .footprint-distribution { background: var(--accent-red); box-shadow: 0 0 8px var(--accent-red); }
    </style>
</head>
<body class="st-body">
    <script src="/static/js/nav.js"></script>
    <div class="st-page" style="background: var(--bg-primary); padding: 2rem;">
        <!-- Command Center Header -->
        <header class="command-center-card" style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h1 style="margin: 0 0 0.5rem; font-size: 2rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem;">
                        üß† Command Center
                        <span class="st-status-dot st-status-dot-active" style="margin-right: 0.5rem;"></span>
                    </h1>
                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Real-time Bot Brain Visualization & Decision Intelligence</p>
                </div>
                <div style="text-align: right;">
                    <div id="liveStatus" style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                        <span class="st-status-dot st-status-dot-active"></span>
                        <span>Bot Active</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Top Row: Whale Sentiment & Market Regime -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
            <!-- Whale Sentiment Gauge -->
            <div class="command-center-card">
                <h2 style="margin: 0 0 1rem; font-size: 1.25rem; font-weight: 600;">Whale Sentiment & Flow</h2>
                <div id="whaleBiasGauge" style="min-height: 250px;"></div>
                <div id="supplyDemandIndicator" style="margin-top: 1rem; text-align: center;"></div>
            </div>

            <!-- Market Regime Dashboard -->
            <div class="command-center-card">
                <h2 style="margin: 0 0 1rem; font-size: 1.25rem; font-weight: 600;">Market Regime</h2>
                <div id="regimeDashboard" style="text-align: center; padding: 2rem 0;">
                    <div id="regimeBadge" class="regime-badge" style="font-size: 1.5rem; padding: 1rem 2rem; margin-bottom: 1rem;">--</div>
                    <div style="color: var(--text-secondary); margin-top: 1rem;">
                        <div style="font-size: 0.875rem; margin-bottom: 0.5rem;">Regime Scale Multiplier</div>
                        <div id="regimeScale" style="font-size: 2rem; font-weight: 700; color: var(--accent-blue);">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dynamic Strategy Radar -->
        <div class="command-center-card">
            <h2 style="margin: 0 0 1rem; font-size: 1.25rem; font-weight: 600;">Dynamic Strategy Radar</h2>
            <p style="margin: 0 0 1.5rem; color: var(--text-secondary); font-size: 0.875rem;">Current strategy weights based on market regime</p>
            <div id="strategyRadar" style="min-height: 400px;"></div>
        </div>

        <!-- Advanced VSA Charting -->
        <div class="command-center-card">
            <h2 style="margin: 0 0 1rem; font-size: 1.25rem; font-weight: 600;">Advanced VSA Charting</h2>
            <p style="margin: 0 0 1.5rem; color: var(--text-secondary); font-size: 0.875rem;">Price action with Whale Footprints (Absorption/Distribution markers)</p>
            <div id="vsaChart" style="min-height: 400px;"></div>
            <div style="margin-top: 1rem;">
                <h3 style="margin: 0 0 0.75rem; font-size: 1rem; font-weight: 600;">Relative Volume (RVOL)</h3>
                <div id="rvolChart" style="min-height: 200px;"></div>
            </div>
        </div>

        <!-- Decision Reasoning: Live Logic Feed -->
        <div class="command-center-card">
            <h2 style="margin: 0 0 1rem; font-size: 1.25rem; font-weight: 600;">Live Logic Feed</h2>
            <p style="margin: 0 0 1.5rem; color: var(--text-secondary); font-size: 0.875rem;">Real-time decision reasoning and Whale Gate explanations</p>
            <div id="logicFeed" style="max-height: 500px; overflow-y: auto;">
                <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">Loading...</div>
            </div>
        </div>

        <footer class="st-footer" style="margin-top: 3rem;">
            <span>SmartTrader ¬© 2025</span>
            <span>Quantiviq ‚Ä¢ Algorithmic Research</span>
        </footer>
    </div>

    <script>
        let whaleBiasChart = null;
        let strategyRadarChart = null;
        let vsaChart = null;
        let rvolChart = null;

        async function loadCommandCenter() {
            try {
                const response = await fetch('/api/insights/command-center');
                const data = await response.json();

                if (data.error) {
                    console.error('Command center error:', data.error);
                    return;
                }

                // Update Whale Bias Gauge
                updateWhaleBiasGauge(data.whale_bias || 0.0, data.vsa_signal || "NO_DATA");
                
                // Update Supply vs Demand Indicator
                updateSupplyDemandIndicator(data.supply_overcoming_demand || false, data.vsa_signal || "NO_DATA");
                
                // Update Market Regime Dashboard
                updateRegimeDashboard(data.current_regime || "NEUTRAL", data.regime_scale || 1.0);
                
                // Update Dynamic Strategy Radar
                updateStrategyRadar(data.dynamic_weights || {});
                
                // Update VSA Charting
                updateVSAChart(data.price_history || [], data.rvol_history || [], data.avg_rvol || 1.0);
                
                // Update Live Logic Feed
                updateLogicFeed(data.reasons || [], data.latest_decision || {}, data.whale_bias || 0.0, data.supply_overcoming_demand || false);
                
            } catch (err) {
                console.error('Command center load error:', err);
            }
        }

        function updateWhaleBiasGauge(whaleBias, vsaSignal) {
            // Convert whale_bias from -1.0 to +1.0 to 0-100 for gauge
            const gaugeValue = ((whaleBias + 1.0) / 2.0) * 100;
            
            const options = {
                series: [gaugeValue],
                chart: {
                    type: 'radialBar',
                    height: 250,
                },
                plotOptions: {
                    radialBar: {
                        startAngle: -90,
                        endAngle: 90,
                        track: {
                            background: '#1e293b',
                            strokeWidth: '97%',
                            margin: 5,
                        },
                        dataLabels: {
                            name: {
                                show: true,
                                fontSize: '16px',
                                fontWeight: 600,
                                color: '#94a3b8',
                                offsetY: -10,
                            },
                            value: {
                                show: true,
                                fontSize: '30px',
                                fontWeight: 700,
                                color: whaleBias > 0 ? '#10b981' : whaleBias < 0 ? '#ef4444' : '#94a3b8',
                                offsetY: 16,
                                formatter: function(val) {
                                    return whaleBias.toFixed(3);
                                }
                            }
                        }
                    }
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shade: 'dark',
                        type: 'horizontal',
                        shadeIntensity: 0.5,
                        gradientToColors: whaleBias > 0 ? ['#10b981'] : ['#ef4444'],
                        inverseColors: true,
                        opacityFrom: 1,
                        opacityTo: 1,
                        stops: [0, 100]
                    }
                },
                labels: ['Whale Bias'],
                colors: whaleBias > 0 ? ['#10b981'] : whaleBias < 0 ? ['#ef4444'] : ['#94a3b8'],
            };

            if (whaleBiasChart) {
                whaleBiasChart.updateOptions(options);
            } else {
                whaleBiasChart = new ApexCharts(document.querySelector("#whaleBiasGauge"), options);
                whaleBiasChart.render();
            }
        }

        function updateSupplyDemandIndicator(supplyOvercoming, vsaSignal) {
            const indicatorEl = document.getElementById('supplyDemandIndicator');
            if (!indicatorEl) return;

            let status, text, className;
            if (supplyOvercoming) {
                status = '‚ö†Ô∏è';
                text = 'Supply Overcoming Demand';
                className = 'supply-overcoming';
            } else if (vsaSignal === 'ABSORPTION') {
                status = '‚úÖ';
                text = 'Demand Dominant';
                className = 'demand-dominant';
            } else {
                status = '‚öñÔ∏è';
                text = 'Balanced';
                className = 'balanced';
            }

            indicatorEl.innerHTML = `
                <div class="supply-demand-indicator ${className}">
                    <span>${status}</span>
                    <span>${text}</span>
                    <span style="font-size: 0.75rem; opacity: 0.8;">(${vsaSignal})</span>
                </div>
            `;
        }

        function updateRegimeDashboard(regime, regimeScale) {
            const badgeEl = document.getElementById('regimeBadge');
            const scaleEl = document.getElementById('regimeScale');
            
            if (badgeEl) {
                badgeEl.textContent = regime;
                badgeEl.className = `regime-badge regime-${regime.toLowerCase()}`;
            }
            
            if (scaleEl) {
                scaleEl.textContent = `√ó${regimeScale.toFixed(2)}`;
            }
        }

        function updateStrategyRadar(dynamicWeights) {
            const categories = ['Trend', 'Momentum', 'MeanRev', 'Breakout', 'Behavior'];
            const values = [
                (dynamicWeights.trend || 0) * 100,
                (dynamicWeights.momentum || 0) * 100,
                (dynamicWeights.meanrev || 0) * 100,
                (dynamicWeights.breakout || 0) * 100,
                (dynamicWeights.behavior || 0) * 100,
            ];

            const options = {
                series: [{
                    name: 'Strategy Weight',
                    data: values,
                }],
                chart: {
                    type: 'radar',
                    height: 400,
                    toolbar: { show: false },
                },
                xaxis: {
                    categories: categories,
                },
                yaxis: {
                    max: 100,
                    min: 0,
                },
                fill: {
                    opacity: 0.3,
                    colors: ['#3b82f6'],
                },
                stroke: {
                    colors: ['#3b82f6'],
                    width: 2,
                },
                markers: {
                    size: 4,
                    colors: ['#3b82f6'],
                },
                plotOptions: {
                    radar: {
                        polygons: {
                            strokeColors: '#1e293b',
                            fill: {
                                colors: ['#131829', '#1a1f35']
                            }
                        }
                    }
                },
                tooltip: {
                    y: {
                        formatter: function(val) {
                            return val.toFixed(1) + '%';
                        }
                    }
                },
            };

            if (strategyRadarChart) {
                strategyRadarChart.updateOptions(options);
            } else {
                strategyRadarChart = new ApexCharts(document.querySelector("#strategyRadar"), options);
                strategyRadarChart.render();
            }
        }

        function updateVSAChart(priceHistory, rvolHistory, avgRvol) {
            if (!priceHistory || priceHistory.length === 0) return;

            // Prepare line chart data
            const priceData = priceHistory.map(c => ({
                x: new Date(c.timestamp).getTime(),
                y: c.price
            }));

            // Find whale footprint markers
            const absorptionData = [];
            const distributionData = [];
            
            priceHistory.forEach((candle) => {
                const timestamp = new Date(candle.timestamp).getTime();
                if (candle.whale_footprint === 'ABSORPTION') {
                    absorptionData.push({
                        x: timestamp,
                        y: candle.price
                    });
                } else if (candle.whale_footprint === 'DISTRIBUTION') {
                    distributionData.push({
                        x: timestamp,
                        y: candle.price
                    });
                }
            });

            const options = {
                series: [{
                    name: 'Price',
                    type: 'line',
                    data: priceData,
                }, {
                    name: 'Absorption',
                    type: 'scatter',
                    data: absorptionData,
                }, {
                    name: 'Distribution',
                    type: 'scatter',
                    data: distributionData,
                }],
                chart: {
                    type: 'line',
                    height: 400,
                    toolbar: { show: true },
                    zoom: { enabled: true },
                },
                stroke: {
                    width: 2,
                    curve: 'smooth',
                    colors: ['#3b82f6'],
                },
                markers: {
                    size: [0, 8, 8],
                    colors: ['#3b82f6', '#10b981', '#ef4444'],
                    strokeColors: ['#3b82f6', '#ffffff', '#ffffff'],
                    strokeWidth: [0, 2, 2],
                    shape: ['line', 'circle', 'circle'],
                    hover: {
                        size: [0, 10, 10],
                    }
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shade: 'dark',
                        type: 'vertical',
                        shadeIntensity: 0.5,
                        gradientToColors: ['#3b82f6'],
                        inverseColors: false,
                        opacityFrom: 0.3,
                        opacityTo: 0.1,
                        stops: [0, 100]
                    }
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        style: {
                            colors: '#94a3b8',
                        }
                    }
                },
                yaxis: {
                    labels: {
                        style: {
                            colors: '#94a3b8',
                        },
                        formatter: function(val) {
                            return val.toLocaleString();
                        }
                    }
                },
                tooltip: {
                    shared: true,
                    intersect: false,
                },
                legend: {
                    show: true,
                    position: 'top',
                    labels: {
                        colors: '#94a3b8',
                    }
                },
                colors: ['#3b82f6', '#10b981', '#ef4444'],
            };

            if (vsaChart) {
                vsaChart.updateOptions(options);
                vsaChart.updateSeries([{
                    name: 'Price',
                    type: 'line',
                    data: priceData,
                }, {
                    name: 'Absorption',
                    type: 'scatter',
                    data: absorptionData,
                }, {
                    name: 'Distribution',
                    type: 'scatter',
                    data: distributionData,
                }]);
            } else {
                vsaChart = new ApexCharts(document.querySelector("#vsaChart"), options);
                vsaChart.render();
            }

            // Update RVOL Chart
            if (rvolHistory && rvolHistory.length > 0) {
                const rvolData = rvolHistory.map(r => ({
                    x: new Date(r.timestamp).getTime(),
                    y: r.rvol
                }));
                const avgRvolData = rvolHistory.map(r => ({
                    x: new Date(r.timestamp).getTime(),
                    y: avgRvol
                }));

                const rvolOptions = {
                    series: [{
                        name: 'RVOL',
                        data: rvolData,
                    }, {
                        name: 'Avg RVOL',
                        data: avgRvolData,
                    }],
                    chart: {
                        type: 'area',
                        height: 200,
                        toolbar: { show: false },
                        stacked: false,
                    },
                    stroke: {
                        width: 2,
                        curve: 'smooth',
                    },
                    fill: {
                        type: 'gradient',
                        gradient: {
                            shade: 'dark',
                            type: 'vertical',
                            shadeIntensity: 0.5,
                            gradientToColors: ['#3b82f6'],
                            inverseColors: false,
                            opacityFrom: 0.3,
                            opacityTo: 0.1,
                        }
                    },
                    xaxis: {
                        type: 'datetime',
                        labels: {
                            style: {
                                colors: '#94a3b8',
                            }
                        }
                    },
                    yaxis: {
                        labels: {
                            style: {
                                colors: '#94a3b8',
                            },
                            formatter: function(val) {
                                return val.toFixed(2);
                            }
                        }
                    },
                    colors: ['#3b82f6', '#94a3b8'],
                    legend: {
                        show: true,
                        position: 'top',
                        labels: {
                            colors: '#94a3b8',
                        }
                    },
                    tooltip: {
                        shared: true,
                        intersect: false,
                    },
                };

                if (rvolChart) {
                    rvolChart.updateOptions(rvolOptions);
                    rvolChart.updateSeries([{
                        name: 'RVOL',
                        data: rvolData,
                    }, {
                        name: 'Avg RVOL',
                        data: avgRvolData,
                    }]);
                } else {
                    rvolChart = new ApexCharts(document.querySelector("#rvolChart"), rvolOptions);
                    rvolChart.render();
                }
            }
        }

        function updateLogicFeed(reasons, latestDecision, whaleBias, supplyOvercoming) {
            const feedEl = document.getElementById('logicFeed');
            if (!feedEl) return;

            if (!reasons || reasons.length === 0) {
                feedEl.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 2rem;">No reasoning data available.</div>';
                return;
            }

            let html = '';
            
            // Add decision summary
            if (latestDecision.decision) {
                const decisionClass = latestDecision.decision === 'BUY' ? 'success' : 
                                     latestDecision.decision === 'SELL' ? 'danger' : 'warning';
                html += `
                    <div class="logic-feed-item ${decisionClass}">
                        <strong>Decision: ${latestDecision.decision}</strong> | 
                        Aggregate S: ${(latestDecision.aggregate_s || 0).toFixed(3)} | 
                        Price: ${(latestDecision.price || 0).toLocaleString()}
                    </div>
                `;
            }

            // Add reasons
            reasons.forEach((reason, idx) => {
                let itemClass = '';
                if (reason.includes('WHALE_GATE') || reason.includes('supply overcoming')) {
                    itemClass = 'danger';
                } else if (reason.includes('BUY') || reason.includes('SELL')) {
                    itemClass = 'success';
                } else if (reason.includes('HOLD') || reason.includes('gated')) {
                    itemClass = 'warning';
                }

                html += `
                    <div class="logic-feed-item ${itemClass}">
                        ${reason}
                    </div>
                `;
            });

            // Add whale gate explanation if applicable
            if (supplyOvercoming && latestDecision.decision === 'HOLD') {
                html += `
                    <div class="logic-feed-item danger">
                        <strong>üêã Whale Gate Activated:</strong> Despite bullish trend signals, 
                        VSA analysis indicates supply overcoming demand (whale_bias: ${whaleBias.toFixed(3)}). 
                        Trade held to avoid bull trap.
                    </div>
                `;
            }

            feedEl.innerHTML = html;
        }

        // Initial load
        loadCommandCenter();

        // Auto-refresh every 15 seconds
        setInterval(loadCommandCenter, 15000);
    </script>
</body>
</html>
